name: Upload Debug Symbols to Sentry

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
        description: "Target OS: windows-latest, macos-14, ubuntu-20.04, ubuntu-24.04"
      pdb-artifact-name:
        required: false
        type: string
        description: "Artifact name for Windows PDB archive (e.g., 'PDB')"
      release:
        required: true
        type: string
        description: "Release version/tag"

jobs:
  upload_symbols:
    name: Upload Debug Symbols to Sentry
    runs-on: ${{ inputs.os }}
    steps:
      # ==================== Windows ====================
      - name: "[Windows] Install sentry-cli via choco"
        if: inputs.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install sentry-cli -y -y 2>&1 | Out-Null

      - name: "[Windows] Download PDB artifact"
        if: inputs.os == 'windows-latest'
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.pdb-artifact-name }}
          path: ./symbols

      - name: "[Windows] Upload PDB to Sentry (sentry-cli)"
        if: inputs.os == 'windows-latest'
        shell: pwsh
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_LOG_LEVEL: debug
        run: |
          $pdbFiles = Get-ChildItem -Path ./symbols -Filter "*.pdb" -File -Recurse
          if ($pdbFiles.Count -gt 0) {
            Write-Host "Found $($pdbFiles.Count) PDB file(s) to upload:"
            $pdbFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }
            Write-Host ""
            Write-Host "Starting Sentry upload with debug logging..."
            sentry-cli.exe --log-level=debug --auth-token $env:SENTRY_AUTH_TOKEN upload-dif --org "${{ secrets.SENTRY_ORG }}" --project "${{ secrets.SENTRY_PROJECT }}" ./symbols 2>&1 | Out-Host
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::error::Sentry upload failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          } else {
            Write-Host "::error::No PDB files found in symbols folder"
            Get-ChildItem -Path ./symbols -Recurse | ForEach-Object { Write-Host "  Found: $($_.FullName)" }
            exit 1
          }

      # ==================== macOS ====================


      # ==================== Linux ====================

